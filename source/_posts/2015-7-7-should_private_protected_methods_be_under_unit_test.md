---
layout: post
title: "单元测试是否应该测试私有/保护方法"
date: 2011-07-07 12:59
comments: true
external-url:
categories:
---

&nbsp;&nbsp;前几日在写单元测试和同事有一番争论:是否应该测试private/protected方法?同事的意见是所有的方法都应该测试,这样能够确保代码覆盖率,在代码改动时只要跑跑case就能确保更改是否正确,心里更安稳.我则觉得,一把菜刀如果做成十斤重,那就丝毫没有使用价值了,如果为private/protected方法都加单元测试,那么测试代码必然急剧膨胀,编写维护测试代码的成本就足以耗死人了,得不偿失.    
&nbsp;&nbsp;我无法说服同事,也感觉似乎无法说服自己,维护测试代码的成本虽然会很高,但仅仅这一个理由, 也不够充分.后来在stackoverflow上,我搜索到了一个关于此论题的[探讨](http://stackoverflow.com/questions/5601730/should-private-protected-methods-be-under-unit-test),一下子豁然开朗.    
&nbsp;&nbsp;参与讨论的人,对此问题,一边倒的给出答案都是不应该测试private方法.具体的理由有:
*   public方法是对象提供给外界的接口,private则是对外部隐藏的内部实现.外界只关心提供的接口是否正确,不关心它是怎么实现.只对public方法测试,就已经可以确保对象工作正常, 无需画蛇添足.
*   对private方法测试, 就需要了解对象内部实现,额,测试代码和具体的实现有了强耦合.那么代码稍微的改动,测试代码的更改就会让人喝一大壶.
*   如果case对代码的覆盖率不够,有些private/protected方法在跑case时没有被hit,要么是对public方法的测试不够充分,要么就是代码结构有问题, 不必为private方法添加case,缘木求鱼的提高覆盖率.

&nbsp;&nbsp;除了这些理由,有人还给出一些形而上的原因.TDD其实从内里来说,是BDD, B是Behavior,所以我们其实测试的是行为, 而不是方法.在测试对象行为时, 暗含的就测试了private/protected方法.这个解释相当简单有力,但我很好奇为什么在讲解单元测试的时候,很少有人能将这个说法放在第一章.还有种说法,测试其实是使用对象的例子,因此只需测试public方法.

&nbsp;&nbsp;protected方法是否应该被测试,则有小部分人给出yes,大部分人还是坚持不应该测试.反方的理由其实和private方法不应该测试一样,public方法已经包含了对象向外界暴露的行为,测试public方法就暗含的测试了protected方法,无需多此一举.正方则反驳说,其实protected方法也算是一种接口,是父类和子类的约定,自然值得测试.   
&nbsp;&nbsp;关于这个问题,我的答案是,只需要测试public方法,理由已在上面列出.如果测试覆盖率不够,我们更应该反思类是否太过庞大,承担了太多职责,以至于测试用例很难完全覆盖所有行为,或者private/protected/public权限设计的不够正确,public方法不符合单一职责原则,做了太多事情,因此测试不友好.坚持只测试public方法, 从编写测试代码的难易程度,也能够相当方面的反应程序设计是否合理.
